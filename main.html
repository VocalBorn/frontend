<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語聲聚來</title>
    <link id="fa-link" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
    document.getElementById('fa-link').addEventListener('error', function() {
        this.href = 'font-awesome.min.css';
    });
    </script>
    <link rel="stylesheet" href="style_sidebar.css">
    <link rel="stylesheet" href="style_home.css">
    <link rel="stylesheet" href="style_practice.css">
    <link rel="stylesheet" href="style_location.css">
    <link rel="stylesheet" href="style_dailyterms.css">
    <link rel="stylesheet" href="style_setting.css">
    <link rel="stylesheet" href="style_chat.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" onerror="
    var script = document.createElement('script');
    script.src = 'chart.min.js';
    document.head.appendChild(script);
    "></script>
</head>
<body>
    <div class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <section id="main" class="page">
        <div class="hamburger">
            <i class="fas fa-bars"></i>
        </div>

        <nav class="sidebar">
            <div class="logo">
                <img src="images/LOGO.png" alt="語聲聚來" style="width: 75%; height: auto; display: block; margin: 0 auto;">
            </div>
            <a href="#" class="nav-link" data-target="home">
                <i class="fas fa-home"></i>首頁
            </a>
            <a href="#" class="nav-link" data-target="progress">
                <i class="fas fa-chart-line"></i>進度追蹤
            </a>
            <a href="#" class="nav-link" data-target="practice">
                <i class="fas fa-gamepad"></i>情境練習
            </a>
            <a href="#" class="nav-link" data-target="location-terms">
                <i class="fa-solid fa-location-dot"></i> 智慧定位
            </a>
            <a href="#" class="nav-link" data-target="daily-terms">
                <i class="fas fa-comments"></i>常用用語
            </a>
            <a href="#" class="nav-link" data-target="instant-messaging-terms">
                <i class="fas fa-user-alt"></i>即時溝通
            </a>  
            <a href="#" class="nav-link" data-target="settings">
                <i class="fas fa-cog"></i>設定
            </a>
        </nav>

        <div class="overlay"></div>

        <div class="main-content">
            <!-- 首頁 -->
            <div id="home-content" class="main-content-page active">
                <section class="hero-section">
                    <div class="hero-content">
                        <h1>歡迎回來，XXX！</h1>
                        <p>今天是您語言治療的第 15 天，讓我們繼續努力吧！</p>
                    </div>
                </section>
                <section class="task-section">
                    <div class="task-title">
                        <i class="fa-solid fa-bolt"></i>
                        今日任務
                    </div>
                    <div class="task-cards">
                        <div id="sign-in-card" class="task-card">
                            <h4>📅 每日簽到</h4>
                            <p>完成今日簽到，保持學習習慣</p>
                            <button class="task-btn" onclick="signInToday()">立即簽到</button>
                        </div>
                        <div id="calendar-container" class="task-card calendar-card hidden">
                            <div class="card-header">
                                <i class="fa-solid fa-calendar-check"></i> 本月簽到紀錄
                            </div>
                            <div class="calendar-nav">
                                <select id="year-select" onchange="updateCalendarFromSelect()"></select>
                                <select id="month-select" onchange="updateCalendarFromSelect()"></select>
                            </div>
                            <div id="calendar-grid" class="calendar-grid"></div>
                        </div>
                        <div class="task-card">
                            <h4>📘 情境練習</h4>
                            <p>完成 1 次醫院情境練習</p>
                            <button class="task-btn" onclick="switchPage('practice')">前往</button>
                            <div class="progress-label">今日學習進度</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 60%;"></div>
                            </div>
                            <div class="progress-wrapper">
                            </div>
                        </div>
                        <div class="task-card">
                            <h4>🗓 預約語言治療時間</h4>
                            <p id="appointment-text">安排下次語言治療的時間，方便追蹤進度</p>
                            <button class="task-btn" id="book-btn">預約</button>
                            <button class="task-btn hidden" id="cancel-btn" style="background-color:#f44336;">取消預約</button>
                        </div>
                        <!-- 預約彈窗 -->
                        <div class="popup hidden" id="appointment-popup">
                            <h3>預約語言治療時間</h3>
                            <label for="appointment-date">日期</label>
                            <input type="date" id="appointment-date">
                            <label for="appointment-time">時間</label>
                            <input type="time" id="appointment-time">
                            <div class="popup-buttons">
                                <button class="popup-confirm-btn" id="confirm-appointment">確認預約</button>
                                <button class="popup-confirm-btn" id="close-popup" style="background-color:#ccc; color:#333;">取消</button>
                            </div>
                        </div>
                </section>
                <section class="motivation-quote">
                    <i class="fas fa-quote-left quote-icon"></i>
                    <div class="quote-text">
                        「持之以恆的練習是進步的關鍵，讓我們一起努力！」
                    </div>
                    <div class="quote-author">- 您的語言治療師</div>
                </section>
                <div id="sign-in-popup" class="popup hidden">
                    <div class="popup-content">
                    <span class="popup-message">✅ 今日簽到完成！</span><br />
                    <button class="popup-confirm-btn" onclick="closePopup()">確定</button>
                    </div>
                </div>
            </div>

            <!-- 進度追蹤 -->
            <div id="progress-content" class="main-content-page">
                <section class="hero-section">
                    <div class="hero-content">
                        <h1>進度追蹤</h1>
                        <p>查看您的學習進度和成就</p>
                    </div>
                </section>

                <div class="quick-stats">
                    <div class="stat-card">
                        <div class="stat-number">12</div>
                        <div class="stat-label">已完成練習</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">85%</div>
                        <div class="stat-label">平均準確率</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">3</div>
                        <div class="stat-label">今日待完成</div>
                    </div>
                </div>

                <section class="progress-section">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i>
                        <h3>學習進度</h3>
                    </div>
                    <div class="progress-chart">
                        <canvas id="progressChart"></canvas>
                    </div>
                </section>

                <section class="achievement-section">
                    <div class="card-header">
                        <i class="fas fa-trophy"></i>
                        <h3>成就</h3>
                    </div>
                    <div class="achievement-grid">
                        <div class="achievement-card">
                            <div class="achievement-icon">
                                <i class="fas fa-medal"></i>
                            </div>
                            <div class="achievement-title">完成 10 次練習</div>
                            <div class="achievement-description">恭喜您完成了 10 次練習，繼續加油！</div>
                        </div>
                        <div class="achievement-card">
                            <div class="achievement-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="achievement-title">達到 90% 準確率</div>
                            <div class="achievement-description">您的平均準確率達到了 90%，保持這個好成績！</div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 情境練習 -->
            <div id="practice-content" class="main-content-page">
                <section class="hero-section">
                    <div class="hero-content">
                        <h1>情境練習</h1>
                        <p>選擇一個情境開始練習</p>
                    </div>
                </section>
            
                <div class="practice-container" id="practice-card-container"> 
                    <!-- <div class="practice-card-list" style="background-image: url('images/restaurant.png');">
                        <div class="practice-card-info">
                            <div class="practice-title">第一章  餐廳</div>
                            <div class="practice-description">學習如何在餐廳點餐</div>
                        </div>
                        <button class="practice-button-list" onclick="showScenario('restaurant')">查看情境</button>
                    </div>
                    <div class="practice-card-list" style="background-image: url('images/hospital.png');">
                        <div class="practice-card-info">
                            <div class="practice-title">第二章  醫院</div>
                            <div class="practice-description">學習如何在醫院就診</div>
                        </div>
                        <button class="practice-button-list" onclick="showScenario('hospital')">查看情境</button>
                    </div>

                    <div class="practice-card-list" style="background-image: url('images/shopping.jpg');">
                        <div class="practice-card-info">
                            <div class="practice-title">第三章  購物付款</div>
                            <div class="practice-description">學習如何在商店付款</div>
                        </div>
                        <button class="practice-button-list" onclick="showScenario('shopping')">查看情境</button>
                    </div>

                    <div class="practice-card-list" style="background-image: url('images/bank.jpg');">
                        <div class="practice-card-info">
                            <div class="practice-title">第四章  銀行</div>
                            <div class="practice-description">學習如何開戶、存錢、提款、換匯</div>
                        </div>
                        <button class="practice-button-list" onclick="showScenario('bank')">查看情境</button>
                    </div>

                    <div class="practice-card-list" style="background-image: url('images/post.jpg');">
                        <div class="practice-card-info">
                            <div class="practice-title">第五章  郵局</div>
                            <div class="practice-description">學習如何寄送郵件或包裹</div>
                        </div>
                        <button class="practice-button-list" onclick="showScenario('post')">查看情境</button>
                    </div>

                    <div class="practice-card-list" style="background-image: url('images/travel.jpg');">
                        <div class="practice-card-info">
                            <div class="practice-title">第六章  旅遊</div>
                            <div class="practice-description">學習如何訂房與問景點</div>
                        </div>
                        <button class="practice-button-list" onclick="showScenario('travel')">查看情境</button>
                    </div>

                    <div class="practice-card-list" style="background-image: url('images/emergency.jpg');">
                        <div class="practice-card-info">
                            <div class="practice-title">第七章  緊急狀況</div>
                            <div class="practice-description">學習在緊急時如何求助和應對</div>
                        </div>
                        <button class="practice-button-list" onclick="showScenario('emergency')">查看情境</button>
                    </div>

                    <div class="practice-card-list" style="background-image: url('images/daily.jpg');">
                        <div class="practice-card-info">
                            <div class="practice-title">第八章  日常用語</div>
                            <div class="practice-description">常見日常用語</div>
                        </div>
                        <button class="practice-button-list" onclick="showScenario('daily')">查看情境</button>
                    </div> -->
                </div>
                

                <div id="practice-video-section" class="practice-hidden">
                    <div id="youtube-player"></div>
                    <div id="video-script-buttons" class="script-button-group"></div>
                    <button id="practice-back-button">返回</button>
                </div>
            </div>
            <div id="feedback-modal" class="modal hidden">
                <div class="modal-content">
                    <span class="close-btn" onclick="closeFeedback()">×</span>
                    <h3 id="feedback-title">治療師回饋</h3>
                    <div id="feedback-body">載入中...</div>
                </div>
            </div>
            <div id="scenario-restaurant" class="scenario-list hidden">
                <div style="margin: 20px 0 10px 20px;">
                    <button onclick="goBackToChapterList()" class="practice-back-button">← 返回章節列表</button>
                </div>
                <h2>🍽 餐廳練習情境</h2>
                <div class="sub-scenario practice-card-container" id="practice-card-container-restaurant">
                    <!-- <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                        <div class="practice-info-left">
                            <div class="practice-title">1-1 內用</div>
                            <div class="practice-description">點選內用流程</div>
                            <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="1-1">開始練習</button>
                        </div>
                        <div class="practice-info-right">
                            <button class="feedback-button" onclick="showFeedback('1-1')">📝查看回饋</button>
                            <button class="ai-analysis-button" onclick="showAIAnalysis('1-1')">📊AI 分析</button>
                        </div>
                        </div>
                    </div>

                    <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                        <div class="practice-info-left">
                            <div class="practice-title">1-2 外帶</div>
                            <div class="practice-description">模擬點外帶流程</div>
                            <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="1-2">開始練習</button>
                        </div>
                        <div class="practice-info-right">
                            <button class="feedback-button" onclick="showFeedback('1-1')">📝查看回饋</button>
                            <button class="ai-analysis-button" onclick="showAIAnalysis('1-1')">📊AI 分析</button>
                        </div>
                        </div>
                    </div> -->
                </div>
            </div>
            <div id="scenario-hospital" class="scenario-list hidden">
                <div style="margin: 20px 0 10px 20px;">
                    <button onclick="goBackToChapterList()" class="practice-back-button">← 返回章節列表</button>
                </div>
                <h2>🏥 醫院練習情境</h2>
                <div class="sub-scenario practice-card-container" id="practice-card-container-hospital">
                    <!-- <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">2-1 看診</div>
                                <div class="practice-description">模擬與醫生對話看病流程</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="2-1">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('2-1')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('2-1')">📊AI 分析</button>
                            </div>
                        </div>
                    </div>

                    <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">2-2 拿藥</div>
                                <div class="practice-description">模擬到藥局領藥流程</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="2-2">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('2-2')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('2-2')">📊AI 分析</button>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
            <div id="scenario-shopping" class="scenario-list hidden">
                <div style="margin: 20px 0 10px 20px;">
                    <button onclick="goBackToChapterList()" class="practice-back-button">← 返回章節列表</button>
                </div>
                <h2>🛍 購物付款練習情境</h2>
                <div class="sub-scenario practice-card-container" id="practice-card-container-shopping">
                    <!-- <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">3-1 結帳</div>
                                <div class="practice-description">模擬在商店結帳付款流程</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="3-1">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('3-1')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('3-1')">📊AI 分析</button>
                            </div>
                        </div>
                    </div>

                    <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">3-2 詢問價格</div>
                                <div class="practice-description">練習詢問商品價格與優惠</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="3-2">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('3-2')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('3-2')">📊AI 分析</button>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
            <div id="scenario-bank" class="scenario-list hidden">
                <div style="margin: 20px 0 10px 20px;">
                    <button onclick="goBackToChapterList()" class="practice-back-button">← 返回章節列表</button>
                </div>
                <h2>🏦 銀行練習情境</h2>
                <div class="sub-scenario practice-card-container" id="practice-card-container-bank">
                    <!-- <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">4-1 開戶</div>
                                <div class="practice-description">模擬到銀行開戶流程</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="4-1">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('4-1')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('4-1')">📊AI 分析</button>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
            <div id="scenario-post" class="scenario-list hidden">
                <div style="margin: 20px 0 10px 20px;">
                    <button onclick="goBackToChapterList()" class="practice-back-button">← 返回章節列表</button>
                </div>
                <h2>📮 郵局練習情境</h2>
                <div class="sub-scenario practice-card-container" id="practice-card-container-post">
                    <!-- <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">5-1 郵寄</div>
                                <div class="practice-description">模擬寄信或包裹流程</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="5-1">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('5-1')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('5-1')">📊AI 分析</button>
                            </div>
                        </div>
                    </div>

                    <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">5-2 取件</div>
                                <div class="practice-description">模擬到郵局領取包裹流程</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="5-2">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('5-2')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('5-2')">📊AI 分析</button>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
            <div id="scenario-travel" class="scenario-list hidden">
                <div style="margin: 20px 0 10px 20px;">
                    <button onclick="goBackToChapterList()" class="practice-back-button">← 返回章節列表</button>
                </div>
                <h2>✈️ 旅遊練習情境</h2>
                <div class="sub-scenario practice-card-container" id="practice-card-container-travel">
                    <!-- <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">6-1 問路</div>
                                <div class="practice-description">模擬旅途中向人問路</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="6-1">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('6-1')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('6-1')">📊AI 分析</button>
                            </div>
                        </div>
                    </div>

                    <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">6-2 買票</div>
                                <div class="practice-description">模擬在旅途中購買門票或車票</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="6-2">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('6-2')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('6-2')">📊AI 分析</button>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
            <div id="scenario-emergency" class="scenario-list hidden">
                <div style="margin: 20px 0 10px 20px;">
                    <button onclick="goBackToChapterList()" class="practice-back-button">← 返回章節列表</button>
                </div>
                <h2>🚨 緊急狀況練習情境</h2>
                <div class="sub-scenario practice-card-container" id="practice-card-container-emergency">
                    <!-- <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">7-1 打電話求助</div>
                                <div class="practice-description">模擬緊急情況打電話求救</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="7-1">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('7-1')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('7-1')">📊AI 分析</button>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
            <div id="scenario-daily" class="scenario-list hidden">
                <div style="margin: 20px 0 10px 20px;">
                    <button onclick="goBackToChapterList()" class="practice-back-button">← 返回章節列表</button>
                </div>
                <h2>🗣 日常用語練習情境</h2>
                <div class="sub-scenario practice-card-container" id="practice-card-container-daily">
                    <!-- <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">8-1 基本禮貌用語</div>
                                <div class="practice-description">請、謝謝、對不起、沒關係等基本日常表達</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="8-1">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('8-1')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('8-1')">📊AI 分析</button>
                            </div>
                        </div>
                    </div>

                    <div class="practice-card-list" style="background-image: url('');">
                        <div class="practice-card-info">
                            <div class="practice-info-left">
                                <div class="practice-title">8-2 打招呼與回應</div>
                                <div class="practice-description">你好、早安、晚安、再見等常用問候語</div>
                                <button class="practice-button" data-youtube="zFBjXTyXBMw" data-scenario="8-2">開始練習</button>
                            </div>
                            <div class="practice-info-right">
                                <button class="feedback-button" onclick="showFeedback('8-2')">📝查看回饋</button>
                                <button class="ai-analysis-button" onclick="showAIAnalysis('8-2')">📊AI 分析</button>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>




            <div id="location-terms-content" class="main-content-page">
                <section class="hero-section">
                    <div class="hero-content">
                        <h1>智慧定位用語</h1>
                        <p>根據您的位置推薦適合的常用語句</p>
                    </div>
                </section>
        
                <div class="location-terms-container">
                    <div class="location-info">
                        <p><i class="fa-solid fa-map-marker-alt"></i> 目前位置：
                        <span id="currentLocation">獲取中...</span></p>
                    </div>
            
                    <div id="map" class="map"></div>
                
            
                    <div id="recommendedTermsList" class="terms-list">
                        <p><i class="fa-solid fa-map-location-dot"></i> 附近地點</p>
                    </div>
            
                    <div id="suggestedPhrases" class="phrases-list hidden">
                        <p><i class="fa-solid fa-lightbulb"></i> 推薦語句</p>
                        <div id="phraseButtons"></div>
                        <button id="backButton" class="back-btn"> 返回地點</button>
                    </div> 
                </div>
            </div>

            <div id="daily-terms-content" class="main-content-page">
                <section class="hero-section">
                    <div class="hero-content">
                        <h1>常用用語</h1>
                        <p>管理和使用您的常用語句</p>
                    </div>
                </section>
        
                <div class="daily-terms-container">
                    <div class="input-group">
                        <input type="text" id="dailyTermInput" placeholder="輸入常用語句">
                    </div>
        
                    <div class="button-group">
                        <button id="playDailyTermButton" class="button">播放</button>
                        <button id="addDailyTermButton" class="button">新增</button>
                    </div>
        
                    <div id="dailyTermsList" class="terms-list">
                        <p><i class="fa-solid fa-heart" style="color: rgb(255, 128, 128); font-size: 24px;"></i> 您的最愛</p>
                    </div>
                </div>
            </div>
            <!-- 即時溝通頁面 -->
            <div id="instant-messaging-terms-content" class="main-content-page">
                <section class="hero-section">
                    <div class="hero-content">
                        <h1>即時溝通</h1>
                        <p>與您的主治醫生即時溝通</p>
                    </div>
                </section>
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="輸入訊息...">
                        <button id="sendButton" class="chat-send-button">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="settings-page" class="main-content-page">
                <div class="setting">
                  <img src="images/User.jpeg" alt="使用者照片" class="user-pic" />
                  <div class="username">這裡是使用者的名字</div>
            
                  <div class="settings-container">
                    <div class="settings-item" id="showProfile">
                      <label class="auth-switch">個人檔案</label>
                      <i class="fas fa-chevron-right"></i>
                    </div>
                    <hr />
                    <div class="settings-item" id="showNotification">
                      <label>通知設定</label><i class="fas fa-chevron-right"></i>
                    </div>
                    <hr />
                    <div class="settings-item" id="showHelp">
                      <label>幫助</label><i class="fas fa-chevron-right"></i>
                    </div>
                    <hr />
                    <div class="settings-item" id="showAbout">
                      <label>關於語聲俱來</label><i class="fas fa-chevron-right"></i>
                    </div>
                    <hr />
                  </div>
            
                  <button class="logout-btn" onclick="logout()">登出</button>
                </div>
            </div>

            <!-- 個人檔案頁面 -->
            <div id="profile-content" class="main-content-page">
            <div class="profile">
                <div class="profile-container">
                    <div class="profile-item" id="showSetting">
                        <label class="auth-switch"><i class="fas fa-chevron-left"></i>返回</label>
                    </div>
                    <hr/>
                    <div class="profile-item">
                        <label class="profile-option" id="edit-name" data-target="edit-name">姓名</label>
                    </div>
                    <hr/>
                    <div class="profile-item">
                        <label class="profile-option" id="editGender" data-target="edit-gender">性別</label>
                    </div>
                    <hr/>
                    <div class="profile-item">
                        <label id="changePassword" class="profile-option" data-target="change-password">變更密碼</label>
                    </div>
                </div>
            </div>
        </div>

            <!-- 姓名編輯頁面 -->
            <div id="edit-name-content" class="main-content-page hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="edit-name-item" id="backToProfile">
                            <label class="auth-switch"><i class="fas fa-chevron-left"></i> 返回</label>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label>編輯姓名</label>
                            <input type="text" id="nameInput" placeholder="輸入新姓名">
                        </div>
                        <hr />
                        <div class="form-group">
                            <button class="button" onclick="saveName()">儲存</button>
                        </div>
                        <hr />
                    </div>
                </div>
            </div>
            <div id="edit-gender-content" class="main-content-page hidden">
                <div class="card">
                    <div class="card-header">
                    <div class="edit-gender-item" id="backToProfileFromGender">
                        <label class="auth-switch"><i class="fas fa-chevron-left"></i> 返回</label>
                    </div>
                    </div>
                    <div class="card-content">
                    <div class="form-group">
                        <label for="genderSelect">選擇性別</label>
                        <select id="genderSelect">
                        <option value="male">男</option>
                        <option value="female">女</option>
                        <option value="other">其他</option>
                        </select>
                    </div>
                    <hr />
                    <div class="form-group">
                        <button class="button" onclick="saveGender()">儲存</button>
                    </div>
                    </div>
                </div>
            </div>
            <div id="change-password-content" class="main-content-page">
                <div class="card">
                    <div class="card-header">
                    <div class="edit-name-item" id="backToProfileFromPassword">
                        <label class="auth-switch"><i class="fas fa-chevron-left"></i> 返回</label>
                    </div>
                    </div>
                    <div class="card-content">
                    <div class="form-group">
                        <label for="currentPassword">目前密碼</label>
                        <input type="password" id="currentPassword" placeholder="請輸入目前密碼" />
                    </div>
                    <hr />
                    <div class="form-group">
                        <label for="newPassword">新密碼</label>
                        <input type="password" id="newPassword" placeholder="請輸入新密碼" />
                    </div>
                    <hr />
                    <div class="form-group">
                        <label for="confirmPassword">確認新密碼</label>
                        <input type="password" id="confirmPassword" placeholder="再次輸入新密碼" />
                    </div>
                    <hr />
                    <div class="form-group">
                        <button class="button" onclick="submitPasswordChange()">儲存變更</button>
                    </div>
                    </div>
                </div>
                </div>

            
            
            <div id="notification-content" class="main-content-page">
                <div class="notification">
                    <div class="notification-container">
                        <div class="notification-item" id="backToSettingfromNotify">
                            <label class="auth-switch"><i class="fas fa-chevron-left"></i>返回</label>
                        </div>
                        <hr/>
                        <div class="notification-item">
                            <label>每日練習提醒</label>
                            <div class="setting-toggle">
                                <label class="switch">
                                  <input type="checkbox" id="notifyToggle" checked>
                                  <span class="slider round"></span>
                                </label>
                              </div>
                              
                        </div>
                    </div>
                </div>
            </div>
        

            <div id="help-content" class="main-content-page">
                <div class="help">
                    <div class="help-container">
                        <div class="help-item" id="backToSettingfromHelp">
                            <label class="auth-switch"><i class="fas fa-chevron-left"></i>返回</label>
                        </div>
                        <hr/>
                        <div class="help-item" id="how-to-change-password-item">
                            <label>如何更改密碼？</label>
                        </div>
                        <hr/>
                        <div class="help-item" id="tutorial-item">
                            <label>使用教學</label>
                        </div>
                    </div>
                </div>
            </div>
            <div id="how-to-change-password-content" class="main-content-page hidden">
                <div class="card">
                    <div class="card-header">
                    <label class="auth-switch" id="backToHelpFromHowTo"><i class="fas fa-chevron-left"></i> 返回</label>
                    </div>
                    <div class="card-content">
                    <h2>如何更改密碼</h2>
                    <ol class="instruction-list">
                        <li>在主畫面點選右側選單「設定」。</li>
                        <li>點選「個人檔案」。</li>
                        <li>在選單中點選「變更密碼」。</li>
                        <li>輸入目前密碼、新密碼與確認密碼，然後按下「儲存」。</li>
                        <li>密碼變更成功後，會自動返回個人檔案頁面。</li>
                    </ol>
                    <p class="tip">⚠️ 新密碼需至少 6 個字元，且兩次輸入必須一致。</p>
                    </div>
                </div>
            </div>
            <div id="tutorial-content" class="main-content-page hidden">
                <div class="card">
                    <div class="card-header">
                    <label class="auth-switch" id="backToHelpFromTutorial">
                        <i class="fas fa-chevron-left"></i> 返回
                    </label>
                    </div>
                    <div class="card-content">
                    <h2>使用教學</h2>
                    <ol class="instruction-list">
                        <li>開啟網站後，請先註冊或登入帳號。</li>
                        <li>登入成功後，進入主畫面，選擇「每日詞彙」可新增語句並播放發音。</li>
                        <li>使用「練習模式」觀看影片並跟讀對話，提升口語能力。</li>
                        <li>進入「智慧定位」，系統會推薦附近場所對應的語句。</li>
                        <li>透過右上角的個人選單可進行「姓名編輯」、「變更密碼」、「性別設定」等個人化設定。</li>
                        <li>點選「進度」頁面可查看學習曲線。</li>
                    </ol>
                    <div class="tip">
                        小提醒：請開啟瀏覽器的麥克風與定位權限，以獲得最佳體驗！
                    </div>
                    </div>
                </div>
            </div>

            <div id="about-content" class="main-content-page">
                <div class="about">
                    <div class="about-container">
                        <div class="about-item" id="backToSettingfromAbout">
                            <label class="auth-switch"><i class="fas fa-chevron-left"></i>返回</label>
                        </div>
                        <hr/>
                        <div class="about-item">
                            <a href="private.html">使用條款與隱私權政策</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script src="js_practice.js"></script>
    <script src="script.js"></script>
    <script src="js_location.js"></script>
    <script src="js_home.js"></script>
    
    <script>
        let ytPlayer;

        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('youtube-player', {
                height: '360',
                width: '640',
                videoId: '', // 先給空值，之後用 loadVideoById 動態載入
                events: {
                    'onReady': (event) => {
                        console.log("✅ YouTube Player 已準備好");
                    }
                }
            });
        }
        function extractYouTubeId(url) {
            const match = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            return match ? match[1] : url; // 沒 match 就原樣回傳
        }

        function showScenario(scenarioId) {
            const cardContainer = document.getElementById('practice-card-container');
            const allScenarios = document.querySelectorAll('.scenario-list');
            const targetSection = document.getElementById(`scenario-${scenarioId}`);
            if (cardContainer) cardContainer.classList.add('hidden');
            allScenarios.forEach(section => section.classList.add('hidden'));
            if (targetSection) targetSection.classList.remove('hidden');
            log(`顯示子情境：${scenarioId}`);
        }
        document.addEventListener('DOMContentLoaded', async() => {
            // const backButton = document.getElementById('practice-back-button');
            //         if (backButton) {
            //             backButton.addEventListener('click', () => {
            //                 document.getElementById('practice-video-section').style.display = 'none';
            //                 document.getElementById('practice-content').style.display = 'block';
            //             });
            //         }
            const token = localStorage.getItem("token");

            if (!token) {
                alert("尚未登入，請重新登入");
                window.location.href = "index.html";
                return;
            }

            // 用 token 呼叫需要授權的 API
            fetch("https://vocalborn.r0930514.work/api/user/profile", {
                method: "PATCH",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
            .then(res => res.json())
            .then(data => {
                console.log("使用者資料：", data);
                // 在畫面上顯示資料
            })
            .catch(err => {
                console.error("取得資料失敗", err);
                alert("驗證失敗，請重新登入");
                window.location.href = "index.html";
            });

            //變更密碼
            window.submitPasswordChange = async function () {
                const currentPassword = document.getElementById('currentPassword').value.trim();
                const newPassword = document.getElementById('newPassword').value.trim();
                const confirmPassword = document.getElementById('confirmPassword').value.trim();

                // 簡單驗證
                if (!currentPassword || !newPassword || !confirmPassword) {
                    alert('請填寫所有欄位');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    alert('新密碼與確認密碼不一致');
                    return;
                }

                const token = localStorage.getItem('token');
                if (!token) {
                    alert("請先登入");
                    window.location.href = 'index.html';
                    return;
                }

                try {
                    console.log("送出的 token：", token);
                    const response = await fetch('https://vocalborn.r0930514.work/api/user/password', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({
                            old_password: currentPassword,
                            new_password: newPassword
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('密碼變更成功');
                        // 清空輸入欄位
                        document.getElementById('currentPassword').value = '';
                        document.getElementById('newPassword').value = '';
                        document.getElementById('confirmPassword').value = '';
                        window.location.href = '#settings';
                    } else {
                        alert(result.message || '密碼變更失敗');
                    }

                } catch (error) {
                    console.error('Error:', error);
                    alert('發生錯誤，請稍後再試');
                }
            };

            // 取得情境列表
            async function fetchSituations() {
                try {
                    const res = await fetch('https://vocalborn.r0930514.work/api/situations/list?skip=0&limit=10', {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await res.json();
                    console.log('API 回傳', data);
                    return data.situations || [];
                } catch (err) {
                    console.error('取得情境失敗', err);
                    return [];
                }
            }

            const locationImages = {
                '餐廳用餐': 'images/restaurant.png',
                '醫院就診': 'images/hospital.png',
                '購物付款': 'images/shopping.jpg',
                '銀行': 'images/bank.jpg',
                '郵局': 'images/post.jpg',
                '旅遊': 'images/travel.jpg',
                '緊急狀況': 'images/emergency.jpg',
                '日常用語': 'images/daily.jpg'
            };

            const locationEngname = {
                '餐廳用餐': 'restaurant',
                '醫院就診': 'hospital',
                '購物付款': 'shopping',
                '銀行': 'bank',
                '郵局': 'post',
                '旅遊': 'travel',
                '緊急狀況': 'emergency',
                '日常用語': 'daily'
            };

            const chapterMap = {
                '餐廳用餐': 1,
                '醫院就診': 2,
                '購物付款': 3,
                '銀行': 4,
                '郵局': 5,
                '旅遊': 6,
                '緊急狀況': 7,
                '日常用語': 8
            };
            

            function renderCards(situations) {
                const container = document.getElementById('practice-card-container');
                //container.innerHTML = '';

                situations.forEach(sit => {
                    const card = document.createElement('div');
                    card.className = 'practice-card-list';
                    const bgImage = locationImages[sit.situation_name] || 'images/default.jpg';
                    const engName=locationEngname[sit.situation_name];
                    const chapterNumber = chapterMap[sit.situation_name] || '?';
                    card.style.backgroundImage = `url('${bgImage}')`;
                    card.innerHTML = `
                        <div class="practice-card-info">
                            <div class="practice-title">第${chapterNumber}章  ${sit.situation_name}</div>
                            <div class="practice-description">${sit.description}</div>
                        </div>
                        <button class="practice-button-list" onclick="fetchChapters('${locationEngname[sit.situation_name]}')">查看情境</button>
                    `;
                    container.appendChild(card);

                });
            }
            //初始化
            async function init() {
                const situations = await fetchSituations();
                // 排序章節
                situations.sort((a, b) => {
                    const orderA = chapterMap[a.situation_name.trim()] || 99;
                    const orderB = chapterMap[b.situation_name.trim()] || 99;
                    return orderA - orderB;
                });
                renderCards(situations);
            }
            init();

            // 情境對照表
            const situationMap = {
                'restaurant': "67c0aee8-7d38-4851-9f34-ec9101762221",
                'hospital': "b319295c-bd24-4cfe-af93-8a0646153d55",
                'shopping': "ef6633c4-46ac-4b54-9500-f90df1d983b2",
                'bank': "0229fa6a-0c0b-465d-b0e9-5b565801663f",
                'post': "24fa65dc-6f42-41fc-a681-af25e777458d",
                'travel': "663de71a-35d3-44b7-b215-573f04e23934",
                'emergency': "b4ec23a2-ec9c-4d74-9dcc-0ee8d29640d3",
                'daily': "bca80ad2-3222-42b7-91e5-4f9e8509200d"
            };

            // 取得某個情境的章節列表
            async function fetchChapters(scenarioId) {
                showScenario(scenarioId);
                const situation_id = situationMap[scenarioId];

                try {
                    const res = await fetch(`https://vocalborn.r0930514.work/api/situations/${situation_id}/chapter/list`, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await res.json();
                    const chapters = data.chapters || [];
                    console.log('data:',data.chapter_id);
        

                    // 選對容器
                    const container = document.getElementById(`practice-card-container-${scenarioId}`);
                    container.innerHTML = '';

                    chapters.forEach(chapter => {
                        const card = document.createElement('div');
                        card.className = 'practice-card-list';
                        const youtubeId = extractYouTubeId(chapter.video_url);
                        console.log(chapter.video_url);
                        card.innerHTML = `
                            <div class="practice-card-info">
                                <div class="practice-info-left">
                                    <div class="practice-title">${chapter.chapter_name}</div>
                                    <div class="practice-description">${chapter.description}</div>
                                    <button class="practice-button" data-youtube="${youtubeId}" data-scenario="${chapter.situation_id}" data-chapter="${chapter.chapter_name}" >
                                        開始練習
                                    </button>
                                </div>
                                <div class="practice-info-right">
                                    <button class="feedback-button" onclick="showFeedback('${chapter.chapter_name}')">📝查看回饋</button>
                                    <button class="ai-analysis-button" onclick="showAIAnalysis('${chapter.chapter_name}')">📊AI 分析</button>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                        // ✅ 新增：只綁在這次渲染的 container 裡的按鈕
                        container.querySelectorAll('.practice-button').forEach(button => {
                            button.addEventListener('click', () => {
                                const youtubeId = button.getAttribute('data-youtube');
                                const scenarioId = button.getAttribute('data-scenario');
                                const chapterName = button.getAttribute('data-chapter');
                                console.log('scenarioID',scenarioId);
                                console.log('chapterName',chapterName);
                                
                                switch(chapterName){
                                    case "1-1 內用":setupScriptButtons(scenarioId,"1-1 內用");
                                        break;
                                    case "1-2 外帶":setupScriptButtons(scenarioId,"1-2 外帶");
                                        break;
                                    case "2-1 看診":setupScriptButtons(scenarioId,"2-1 看診");
                                        break;
                                    case "2-2 拿藥":setupScriptButtons(scenarioId,"2-2 拿藥");
                                        break;
                                    case "3-1 結帳":setupScriptButtons(scenarioId,"3-1 結帳");
                                        break;
                                    case "3-2 詢問價格":setupScriptButtons(scenarioId,"3-2 詢問價格");
                                        break;
                                    case "4-1 開戶":setupScriptButtons(scenarioId,"4-1 開戶");
                                        break;
                                    case "5-1 郵寄":setupScriptButtons(scenarioId,"5-1 郵寄");
                                        break;
                                    case "5-2 取件":setupScriptButtons(scenarioId,"5-2 取件");
                                        break;
                                    case "6-1 問路":setupScriptButtons(scenarioId,"6-1 問路");
                                        break;
                                    case "6-2 買票":setupScriptButtons(scenarioId,"6-2 買票");
                                        break;
                                    case "7-1 打電話求助":setupScriptButtons(scenarioId,"7-1 打電話求助");
                                        break;
                                    case "8-1 基本禮貌用語":setupScriptButtons(scenarioId,"8-1 基本禮貌用語");
                                        break;
                                    case "8-2 打招呼與回應":setupScriptButtons(scenarioId,"8-2 打招呼與回應");
                                        break;
                                }
                                

                                if (ytPlayer && typeof ytPlayer.loadVideoById === "function") {
                                    ytPlayer.loadVideoById(youtubeId); // 每次都播放
                                    currentVideoId = youtubeId;
                                    console.log(`▶️ 播放影片：${youtubeId}`);

                                    // ✅ 記錄練習開始時間
                                    practiceStartTime = new Date();
                                    console.log("⏱ 練習開始於", practiceStartTime.toLocaleTimeString());

                                    document.getElementById('practice-video-section').classList.remove('practice-hidden');
                                    document.getElementById('practice-card-container').classList.add('practice-hidden');
                                    document.querySelectorAll('.scenario-list').forEach(s => s.classList.add('hidden'));
                                } else {
                                    console.error('❌ 缺少 ytPlayer 或 loadVideoById');
                                }
                            });
                        });
                        //setupScriptButtons(chapter.chapter_name)
                        bindPracticeBackButton()
                    });
                } catch (err) {
                    console.error(`取得 situation_id=${situation_id} 章節列表失敗`, err);
                }
            }
            window.fetchChapters = fetchChapters;


                // 🔹 載入使用者個人資料（姓名、性別）
                try {
                    const res = await fetch("https://vocalborn.r0930514.work/api/user/profile", {
                        method: "GET",
                        headers: {
                            "Authorization": "Bearer " + token
                        }
                    });

                    const data = await res.json();
                    console.log("使用者資料：", data);

                    // 顯示使用者名稱
                    const usernameDiv = document.querySelector('.username');
                    if (usernameDiv && data.name) {
                        usernameDiv.textContent = data.name;
                    }

                    // 顯示姓名與性別到表單
                    if (data.name) {
                        const nameInput = document.getElementById("nameInput");
                        if (nameInput) nameInput.value = data.name;
                    }

                    if (data.gender) {
                        const genderSelect = document.getElementById("genderSelect");
                        if (genderSelect) {
                            const genderMap = {
                                male: "male", //後者(綠色)是html的value（第364行）
                                female: "female", 
                                other: "other"
                            };
                            const mappedGender = genderMap[data.gender.toLowerCase()];
                            if (mappedGender) {
                                genderSelect.value = mappedGender;
                            } else {
                                console.warn("未知的性別值：", data.gender);
                            }
                        }
                    }

                } catch (error) {
                    console.error("載入使用者資料失敗", error);
                    alert("取得個人資料失敗，請重新登入");
                    window.location.href = "index.html";
                }
            
            //更改個人資料內容
            // 設定儲存姓名功能
            window.saveName = async function () {
                const newName = document.getElementById("nameInput").value.trim();
                if (!newName) {
                    alert("請輸入新姓名");
                    return;
                }

                try {
                    const res = await fetch("https://vocalborn.r0930514.work/api/user/profile", {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + token
                        },
                        body: JSON.stringify({ name: newName })
                    });

                    const result = await res.json();
                    if (res.ok) {
                        alert("姓名已更新");
                        // 同步更新畫面上的名稱
                        const usernameDiv = document.querySelector(".username");
                        if (usernameDiv) usernameDiv.textContent = newName;
                        window.location.href = '#settings';
                    } else {
                        alert(result.message || "更新失敗");
                    }
                } catch (err) {
                    console.error("更新姓名失敗：", err);
                    alert("發生錯誤，請稍後再試");
                }
            };

            // 設定儲存性別功能
            window.saveGender = async function () {
                const newGender = document.getElementById("genderSelect").value;

                try {
                    const res = await fetch("https://vocalborn.r0930514.work/api/user/profile", {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + token
                        },
                        body: JSON.stringify({ gender: newGender })
                    });

                    const result = await res.json();
                    if (res.ok) {
                        alert("性別已更新");
                        window.location.href = '#settings';
                    } else {
                        alert(result.message || "更新失敗");
                    }
                } catch (err) {
                    console.error("更新性別失敗：", err);
                    alert("發生錯誤，請稍後再試");
                }
            };

        });
    </script>
    <div id="youtube-player"></div>
<script src="https://www.youtube.com/iframe_api"></script>

</body>
</html>
